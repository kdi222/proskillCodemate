{"version":3,"sources":["../src/codeeditors.js"],"names":["define","$","url","aceTheme","setupAceEditors","$textareas","aceSize","aceLang","aceEditor","prevY","$placeholderBeingResized","undefined","each","$textarea","this","$editorPlaceholder","width","height","id","attr","class","insertAfter","hide","mousedown","event","clientY","preventDefault","ace","edit","setOptions","theme","mode","$blockScrolling","Infinity","getSession","setValue","val","setReadOnly","is","click","getValue","window","mousemove","i","resize","mouseup","loadAce","Deferred","resolve","ACESCRIPTLOCATION","relativeUrl","ajax","dataType","cache","success","config","set","setupFormEditors","callback","done","setupQuestionEditor","$setTextButtons","lineOffset","data","setOption","text","removeAttr"],"mappings":"AAsBAA,QAAQ,SAAU,YAAa,SAASC,EAAGC,GAGvC,IAAIC,EAUJ,SAASC,EAAgBC,EAAYC,EAASC,GAC1C,IAAIC,EAGAC,EACAC,EAA2B,KAwD/B,YAtDgBC,IAAZJ,IACAA,EAAU,cAGdF,EAAWO,KAAK,WACZ,IAAIC,EAAYZ,EAAEa,MACdC,EAAqBd,EAAE,SACvBe,MAAO,OACPC,OAAQX,EACRY,GAAM,mBAAqBL,EAAUM,KAAK,QAC1CC,MAAS,oBACVC,YAAYR,GACfA,EAAUS,OAEVrB,EAAE,SACEiB,GAAM,cAAgBL,EAAUM,KAAK,QACrCC,MAAS,eACVC,YAAYN,GACdQ,UAAU,SAASC,GAChBf,EAAQe,EAAMC,QACdf,EAA2BK,EAC3BS,EAAME,oBAIVlB,EAAYmB,IAAIC,KAAKb,EAAmB,KAC9Bc,YACNC,MAAO,aAAe3B,EACtB4B,KAAM,YAAcxB,IAExBC,EAAUwB,gBAAkBC,EAAAA,EAC5BzB,EAAU0B,aAAaC,SAAStB,EAAUuB,OAC1C5B,EAAU6B,YAAYxB,EAAUyB,GAAG,eAGnCrC,EAAE,4CAA4CsC,MAAM,WAEhD1B,EAAUuB,IAAIT,IAAIC,KAAK,mBAAqBf,EAAUM,KAAK,SAASqB,gBAI5EvC,EAAEwC,QAAQC,UAAU,SAASlB,GACrBd,IACAA,EAAyBO,OAAO,SAAS0B,EAAG1B,GACxC,OAAOA,EAASO,EAAMC,QAAUhB,IAEpCA,EAAQe,EAAMC,QACdE,IAAIC,KAAKlB,EAAyB,IAAIkC,SACtCpB,EAAME,oBAEXmB,QAAQ,WACPnC,EAA2B,OAGxBF,EAOX,SAASsC,IACL,GAAkB,oBAAPnB,IACP,OAAO1B,EAAE8C,WAAWC,UAExB,IAAIC,EAAoB/C,EAAIgD,YAAY,wBACxC,OAAOjD,EAAEkD,MACLjD,IAAK+C,EAAoB,UACzBG,SAAU,SACVC,OAAO,EACPC,QAAS,WACL3B,IAAI4B,OAAOC,IAAI,WAAYP,MAKvC,OAEIQ,iBAAkB,SAAS3B,EAAO4B,GAC9BvD,EAAW2B,EACXgB,IAAUa,KAAK,WACXvD,EAAgBH,EAAE,yBAA0B,SAC5CyD,OAKRE,oBAAqB,SAAS9B,EAAOjB,EAAWgD,EAAiBC,EAAYJ,GACzEvD,EAAW2B,EACXgB,IAAUa,KAAK,WAEX,IAAInD,EAAYJ,EAAgBS,EAAW,QAASA,EAAUkD,KAAK,iBAEnEvD,EAAUwD,UAAU,kBAAmBF,GAEvCD,EAAgBjD,KAAK,WACjB,IAAIqD,EAAOhE,EAAEa,MAAMiD,KAAK,QACxB9D,EAAEa,MAAMoD,WAAW,aACnBjE,EAAEa,MAAMyB,MAAM,SAASf,GACfhB,EAAUgC,YAAcyB,GACxBzD,EAAU2B,SAAS8B,GAEvBzC,EAAME,qBAGdgC","file":"codeeditors.min.js","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides utility methods to setup resizable ace editors into a page.\n * @copyright  Astor Bizard, 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals ace */\ndefine(['jquery', 'core/url'], function($, url) {\n\n    // Global Ace editor theme to use for all editors.\n    var aceTheme;\n\n    /**\n     * Setup each specified textarea with Ace editor, with a vertical resize feature.\n     * It inherits readonly attribute from textarea.\n     * @param {jQuery} $textareas JQuery set of textareas from which to set up editors.\n     * @param {String} aceSize Initial CSS size of editors.\n     * @param {String} aceLang (optional) Lang (mode) to setup editors from.\n     * @return {Editor} The last editor set up.\n     */\n    function setupAceEditors($textareas, aceSize, aceLang) {\n        var aceEditor;\n\n        // Vertical resizing.\n        var prevY;\n        var $placeholderBeingResized = null;\n\n        if (aceLang === undefined) {\n            aceLang = 'plain_text';\n        }\n\n        $textareas.each(function() {\n            var $textarea = $(this);\n            var $editorPlaceholder = $('<div>', {\n                width: '100%',\n                height: aceSize,\n                'id': 'ace_placeholder_' + $textarea.attr('name'),\n                'class': 'ace-placeholder'\n            }).insertAfter($textarea);\n            $textarea.hide();\n\n            $('<div>', {\n                'id': 'ace_resize_' + $textarea.attr('name'),\n                'class': 'ace-resize'\n            }).insertAfter($editorPlaceholder)\n            .mousedown(function(event) {\n                prevY = event.clientY;\n                $placeholderBeingResized = $editorPlaceholder;\n                event.preventDefault();\n            });\n\n            // This is what creates the Ace editor within the placeholder div.\n            aceEditor = ace.edit($editorPlaceholder[0]);\n            aceEditor.setOptions({\n                theme: 'ace/theme/' + aceTheme,\n                mode: 'ace/mode/' + aceLang\n            });\n            aceEditor.$blockScrolling = Infinity; // Disable ace warning.\n            aceEditor.getSession().setValue($textarea.val());\n            aceEditor.setReadOnly($textarea.is('[readonly]'));\n\n            // On submit or run/check, propagate the changes to textarea.\n            $('input[type=submit], .qvpl-buttons button').click(function() {\n                // Cannot use aceEditor here, as it will have another value later.\n                $textarea.val(ace.edit('ace_placeholder_' + $textarea.attr('name')).getValue());\n            });\n        });\n\n        $(window).mousemove(function(event) {\n            if ($placeholderBeingResized) {\n                $placeholderBeingResized.height(function(i, height) {\n                    return height + event.clientY - prevY;\n                });\n                prevY = event.clientY;\n                ace.edit($placeholderBeingResized[0]).resize();\n                event.preventDefault();\n            }\n        }).mouseup(function() {\n            $placeholderBeingResized = null;\n        });\n\n        return aceEditor;\n    }\n\n    /**\n     * Loads Ace script from VPL plugin.\n     * @return {Promise} A promise that resolves upon load.\n     */\n    function loadAce() {\n        if (typeof ace != 'undefined') {\n            return $.Deferred().resolve();\n        }\n        var ACESCRIPTLOCATION = url.relativeUrl(\"/mod/vpl/editor/ace9\");\n        return $.ajax({\n            url: ACESCRIPTLOCATION + '/ace.js',\n            dataType: 'script',\n            cache: true,\n            success: function() {\n                ace.config.set('basePath', ACESCRIPTLOCATION);\n            }\n        });\n    }\n\n    return {\n        // Setup editors in question edition form.\n        setupFormEditors: function(theme, callback) {\n            aceTheme = theme;\n            loadAce().done(function() {\n                setupAceEditors($('.code-editor textarea'), '170px');\n                callback();\n            });\n        },\n\n        // Setup editor in answer form.\n        setupQuestionEditor: function(theme, $textarea, $setTextButtons, lineOffset, callback) {\n            aceTheme = theme;\n            loadAce().done(function() {\n                // Setup question editor.\n                var aceEditor = setupAceEditors($textarea, '200px', $textarea.data('templatelang'));\n                // Set first line number to match compilation messages.\n                aceEditor.setOption('firstLineNumber', lineOffset);\n                // Setup reset and correction buttons (if present, ie. not review mode).\n                $setTextButtons.each(function() {\n                    var text = $(this).data('text');\n                    $(this).removeAttr('data-text');\n                    $(this).click(function(event) {\n                        if (aceEditor.getValue() != text) {\n                            aceEditor.setValue(text);\n                        }\n                        event.preventDefault();\n                    });\n                });\n                callback();\n            });\n        }\n    };\n});"]}
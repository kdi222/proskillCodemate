{"version":3,"sources":["../src/editform.js"],"names":["define","$","jqui","log","VPLService","CodeEditors","ScriptsLoader","updateEditorContent","aceEditor","newContent","getSession","setValue","setUndoManager","ace","UndoManager","updateExecfilesVisibility","selectedVpl","val","showPrecheckExecfiles","toggle","length","edit","resize","applyTemplateChoice","keepContents","call","then","reqfile","lang","langOfFile","name","each","this","setMode","contents","fail","message","error","execfiles","setupExecfiles","filter","execfile","includes","fileTabs","placeholder","$hiddenField","$fileTabs","html","execfilesObj","initialContents","JSON","parse","forEach","content","isBinary","append","startsWith","stringify","click","event","is","updateExecfile","preventDefault","storeExecfile","text","getValue","first","fileName","fileContent","$prevFile","$newFile","prevFileContent","removeClass","toggleClass","addClass","newFile","container","parent","css","M","util","get_string","appendTo","remove","setup","aceTheme","templateChangeHelpButton","vplVersion","setupFormEditors","loadVPLUtil","helpButton","$templateSelect","templateChangeMessage","$templateChangeDialog","dialog","autoOpen","dialogClass","title","closeOnEscape","modal","buttons","class","data","open","focus","change"],"mappings":"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","file":"editform.min.js","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Defines the behavior of the editing form for a vplquestion.\n * @copyright  Astor Bizard, 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals ace */\ndefine(['jquery', 'jqueryui', 'core/log', 'qtype_vplquestion/vplservice', 'qtype_vplquestion/codeeditors',\n'qtype_vplquestion/scriptsloader'], function($, jqui, log, VPLService, CodeEditors, ScriptsLoader) {\n\n    /**\n     * Set editor content to a new content.\n     * This is a hard reset (undo history is cleared).\n     * @param {Editor} aceEditor Ace editor object to reset.\n     * @param {String} newContent The new content to put in the editor.\n     */\n    function updateEditorContent(aceEditor, newContent) {\n        aceEditor.getSession().setValue(newContent);\n        aceEditor.getSession().setUndoManager(new ace.UndoManager());\n    }\n\n    /**\n     * Update display of execution files editors.\n     * This does not include file tabs nor content updating. This is only a visibility update on some elements.\n     */\n    function updateExecfilesVisibility() {\n        var selectedVpl = $('#id_templatevpl').val() > '';\n        var showPrecheckExecfiles = $('#id_precheckpreference').val() == 'diff';\n        $('.novplmessage').toggle(!selectedVpl);\n        $('#execfileslist, #fitem_id_execfile').toggle(selectedVpl);\n\n        $('#fitem_id_precheckexecfileslist').toggle(showPrecheckExecfiles);\n        $('#precheckexecfileslist, #fitem_id_precheckexecfile').toggle(selectedVpl && showPrecheckExecfiles);\n\n        // Refresh previously hidden editor (which otherwise does not display correctly).\n        if ($('#ace_placeholder_precheckexecfile').length) {\n            ace.edit('ace_placeholder_precheckexecfile').resize();\n        }\n    }\n\n    /**\n     * Apply the current VPL template choice to form elements that depends on it (template content, execution files, ...).\n     * @param {Boolean} keepContents Whether editors contents should be kept.\n     *  This is typically false on initialization, true otherwise.\n     */\n    function applyTemplateChoice(keepContents) {\n        var selectedVpl = $('#id_templatevpl').val();\n        $('#fitem_id_templatecontext').toggle(selectedVpl > '');\n        updateExecfilesVisibility();\n        if (selectedVpl) {\n            // Update template content.\n            VPLService.call('info', 'reqfile', selectedVpl)\n            .then(function(reqfile) {\n                var lang = VPLService.langOfFile(reqfile.name);\n                // Apply language change on editors.\n                $('.code-editor:not(.manylangs) .ace-placeholder').each(function() {\n                    ace.edit(this).getSession().setMode('ace/mode/' + lang);\n                });\n\n                // Store lang in hidden form element.\n                $('[name=templatelang]').val(lang);\n\n                if (!keepContents) {\n                    // Choice changed (it is not initialization):\n                    // Reinitialize template content to its original (VPL) state.\n                    updateEditorContent(ace.edit('ace_placeholder_templatecontext'), reqfile.contents);\n                }\n            })\n            .fail(function(message) { // The .catch method doesn't exist as it is a $.Deferred object (and not Promise).\n                log.error(message, 'Error retrieving required files info for VPL ' + selectedVpl);\n            });\n\n            // Update execution files.\n            VPLService.call('info', 'execfiles', selectedVpl)\n            .then(function(execfiles) {\n                // Filter new exec files to exclude standard scripts.\n                execfiles = execfiles.filter(function(execfile) {\n                    return !['vpl_run.sh', 'vpl_debug.sh', 'vpl_evaluate.sh', 'pre_vpl_run.sh'].includes(execfile.name);\n                });\n\n                setupExecfiles(execfiles, keepContents, '#execfileslist',\n                        'ace_placeholder_execfile', $('[name=execfiles]'));\n                setupExecfiles(execfiles, keepContents, '#precheckexecfileslist',\n                        'ace_placeholder_precheckexecfile', $('[name=precheckexecfiles]'));\n            })\n            .fail(function(message) { // The .catch method doesn't exist as it is a $.Deferred object (and not Promise).\n                log.error(message, 'Error retrieving execution files info for VPL ' + selectedVpl);\n            });\n        }\n    }\n\n    /**\n     * Setup execution files editor and tabs to specified files.\n     * @param {{name: String, contents: String}[]} execfiles Array of execution files.\n     * @param {Boolean} keepContents Whether current contents should be kept, or overwritten.\n     * @param {String} fileTabs Tabs selector for execution files.\n     * @param {String} placeholder Placeholder id for editor.\n     * @param {jQuery} $hiddenField Hidden form field in which files data is stored.\n     */\n    function setupExecfiles(execfiles, keepContents, fileTabs, placeholder, $hiddenField) {\n        var aceEditor = ace.edit(placeholder);\n        // Empty exec files list.\n        var $fileTabs = $(fileTabs).html('');\n\n        // Create exec files object to store in hidden form element, and create file tabs.\n        var execfilesObj = {};\n        var initialContents = $hiddenField.val().length > 0 ? JSON.parse($hiddenField.val()) : {};\n        execfiles.forEach(function(execfile) {\n            var content;\n            if (VPLService.isBinary(execfile.name)) {\n                // Binary file are not editable here.\n                content = 'UNUSED';\n            } else {\n                content = (keepContents && initialContents[execfile.name]) || execfile.contents;\n            }\n            execfilesObj[execfile.name] = content;\n            $fileTabs.append('<li class=\"execfilename float-left\">' +\n                                 '<span class=\"clickable rounded-top' + (content.startsWith('UNUSED') ? ' unused' : '') + '\">' +\n                                     execfile.name +\n                                 '</span>' +\n                             '</li>');\n        });\n        $hiddenField.val(JSON.stringify(execfilesObj));\n\n        // Setup file tabs navigation.\n        $(fileTabs + ' .execfilename span').click(function(event) {\n            if (!$(this).is('.currentfile')) {\n                updateExecfile($(fileTabs + ' .currentfile'), $(this), aceEditor, $hiddenField);\n            }\n            event.preventDefault();\n        });\n\n        // On form submit, write current editor value to the field that will be saved.\n        $('input[type=submit]').click(function() {\n            storeExecfile($(fileTabs + ' .currentfile').text(), aceEditor.getValue(), $hiddenField);\n        });\n\n        // Initialize/re-initialize editor.\n        updateExecfile(null, $(fileTabs + ' .execfilename span').first(), aceEditor, $hiddenField);\n    }\n\n    /**\n     * Store a file's content to hidden form element.\n     * @param {String} fileName File name.\n     * @param {String} fileContent File content.\n     * @param {jQuery} $hiddenField Hidden form field in which files data is stored.\n     */\n    function storeExecfile(fileName, fileContent, $hiddenField) {\n        var execfiles = JSON.parse($hiddenField.val());\n        execfiles[fileName] = fileContent;\n        $hiddenField.val(JSON.stringify(execfiles));\n    }\n\n    /**\n     * Update Ace editor and tabs after user swapped to another file.\n     * @param {jQuery} $prevFile The previously selected tab.\n     * @param {jQuery} $newFile The new tab selected by the user.\n     * @param {Editor} aceEditor Ace editor object.\n     * @param {jQuery} $hiddenField Hidden form field in which files data is stored.\n     */\n    function updateExecfile($prevFile, $newFile, aceEditor, $hiddenField) {\n        var prevFileContent = aceEditor.getValue();\n        if ($prevFile !== null) {\n            $prevFile.removeClass('currentfile');\n            $prevFile.toggleClass('unused', prevFileContent.startsWith('UNUSED'));\n            storeExecfile($prevFile.text(), prevFileContent, $hiddenField);\n        }\n        $newFile.addClass('currentfile');\n        var newFile = $newFile.text();\n        if (VPLService.isBinary(newFile)) {\n            if ($('.qvpl-binary-file').length == 0) {\n                $(aceEditor.container).parent().addClass('invisible');\n                $('<pre>')\n                .addClass('qvpl-binary-file visible bg-white text-center h-100 p-3 position-relative')\n                .css('z-index', '1')\n                .text(M.util.get_string('binaryfile', 'mod_vpl'))\n                .appendTo($(aceEditor.container));\n            }\n        } else {\n            $('.qvpl-binary-file').remove();\n            $(aceEditor.container).parent().removeClass('invisible');\n            aceEditor.getSession().setMode('ace/mode/' + VPLService.langOfFile(newFile));\n        }\n        updateEditorContent(aceEditor, JSON.parse($hiddenField.val())[newFile]);\n    }\n\n    /**\n     * Setup behaviour for template VPL change, by displaying a dialog with Overwrite/Merge/Cancel options.\n     * The dialog will only show up if there is data to merge/overwrite.\n     * @param {String} helpButton HTML fragment for help button.\n     */\n    function setupTemplateChangeManager(helpButton) {\n        var $templateSelect = $('#id_templatevpl');\n        var templateChangeMessage = M.util.get_string('templatevplchangeprompt', 'qtype_vplquestion') + helpButton;\n        var $templateChangeDialog = $('<div class=\"py-3\">' + templateChangeMessage + '</div>').dialog({\n            autoOpen: false,\n            dialogClass: 'vplchangedialog p-3 bg-white',\n            title: M.util.get_string('templatevplchange', 'qtype_vplquestion'),\n            closeOnEscape: false,\n            modal: true,\n            buttons:\n            [{\n                text: M.util.get_string('overwrite', 'qtype_vplquestion'),\n                'class': 'btn btn-primary mx-1',\n                click: function() {\n                    // Apply the change without merging.\n                    $templateSelect.data('current', $templateSelect.val());\n                    $(this).dialog('close');\n                    applyTemplateChoice(false);\n                }\n            },\n            {\n                text: M.util.get_string('merge', 'qtype_vplquestion'),\n                'class': 'btn btn-primary mx-1',\n                click: function() {\n                    // Apply the change with merging.\n                    $templateSelect.data('current', $templateSelect.val());\n                    $(this).dialog('close');\n                    applyTemplateChoice(true);\n                }\n            },\n            {\n                text: M.util.get_string('cancel', 'moodle'),\n                'class': 'btn btn-secondary mx-1',\n                click: function() {\n                    // Undo select change.\n                    $templateSelect.val($templateSelect.data('current'));\n                    $(this).dialog('close');\n                }\n            }],\n            open: function() {\n                // By default, focus is on help button - make it less aggressive by focusing on the dialog.\n                $('.vplchangedialog').focus();\n            }\n        });\n        $templateSelect.focus(function() {\n            // Save the previous value to manage cancel.\n            $(this).data('current', $(this).val());\n        }).change(function() {\n            if ($templateSelect.val() && $('[name=execfiles]').val() != '') {\n                // There is data to merge/overwrite, open a dialog to prompt the user.\n                $templateChangeDialog.dialog('open');\n            } else {\n                // There is nothing to merge/overwrite, simply apply the change.\n                $templateSelect.data('current', $templateSelect.val());\n                applyTemplateChoice(false);\n            }\n        });\n    }\n\n    return {\n        setup: function(aceTheme, templateChangeHelpButton, vplVersion) {\n            // Setup all form editors.\n            CodeEditors.setupFormEditors(aceTheme, function() {\n                ScriptsLoader.loadVPLUtil(vplVersion, function() {\n                    // Setup form behavior (VPL template, execution files, etc).\n                    applyTemplateChoice(true);\n                    // Manage VPL template change.\n                    setupTemplateChangeManager(templateChangeHelpButton);\n                    $('#id_precheckpreference').change(updateExecfilesVisibility);\n                });\n            });\n        }\n    };\n});"]}